#!/bin/bash

# image file -> block device
# for mount linux kernel image file.
# written by Steve Jeong (steve@how2flow.net).

set -e

TOP_PATH="$(pwd -P)"
BLOCK="$(sudo losetup -f)"

# EUID
if [[ ! -x "$(command -v sudo)" && $EUID -ne 0 ]]; then
  echo "please run as 'root'"
  exit 1
fi

echo ""
read -r -p "Select option: losetup[s] or delete[d]? [s/d]: " option
case ${option} in
  [sS])
    [ ! -d tmp ] && mkdir -p tmp
    read -r -p "Target Image file:" img
    sudo losetup ${BLOCK} ${img} # delete: losetup -d ${BLOCK}
    sudo partx -v --add ${BLOCK}
    OLD_BLOCK="${BLOCK}"
    export LOSETUP=1
    ;;
  [dD])
    if [ "${LOSETUP}" -eq 1 ]; then
      sudo losetup -d ${OLD_BLOCK}
      export LOSETUP=0
    else
      echo "There is no losetuped loop device"
    fi
    ;;
  *)
    echo "Invalid option"
    ;;
esac

echo "..."
echo "..."
echo "===================================="
echo "Complete losetup image file"
echo ""
echo "Usage:"
echo ""
echo "    mount \"${BLOCK}p#\" $(pwd)/tmp"
echo "===================================="

# vim: ft=sh ts=2 sw=2 sts=2 et
